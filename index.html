<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>wikigame</title>
    <style>
    	* { padding: 0; margin: 0; }
    	canvas { background: #eee; display: block; margin: 0 auto; }
    </style>
    <input placeholder="Enter some text" style="position:absolute;left:100px;top:600px;width:600px;" name="name"/>
</head>
<body>

<p align="center">
<canvas id="myCanvas" width="960" height="640"></canvas>
<p align="center">

<script type="text/javascript">
	var canvas = document.getElementById("myCanvas");
	var ctx = canvas.getContext("2d");
	ctx.font = '12px serif';

	var x = canvas.width/2;
	var y = canvas.height/2;
	var x2 = canvas.width/2;
	var y2 = canvas.height/2;

	var t = 5;
	var str = "";
	var data;
	var myImg = new Image(100,200);
	var html;
	var change = true;
	var translated_text = "";
	var n;

	// myImg.onload = function() {
	// 	ctx.drawImage(myImg, 0, 0);
	// };

	async function getRandomArticle() {
		const endpoint = "https://en.wikipedia.org/api/rest_v1/page/random/mobile-sections";
		try {
			var response = await fetch(endpoint);
			data = await response.json();
			var passed = await filter(data);
			if (!passed) await getRandomArticle();
			str = await data;
			html = str.lead.sections[0].text;
			html = html.replace(new RegExp(str.lead.normalizedtitle, 'i'), "CENSORED");
			//html = (str.remaining.sections[Math.max(0,Math.floor(Math.random()*str.remaining.sections.length - 1))]).text;
			change = true;
		}
		 catch (error) {
			console.log(error);
			}
  		}

	const input = document.querySelector('input');
	input.addEventListener('keyup', function onEvent(e) { 
		if (e.key === "Enter") {
			// clear both input and log
			// check game logic (guess vs. answer -> transition)
			if(str.lead.normalizedtitle == input.value){
				getRandomArticle();
			}
			speechSynthesis.speak(new SpeechSynthesisUtterance('What a terrible guess.'));
			input.value = "";
		}
	});

	async function filter(data){ // true if passes filter 
		// var len = ;
		// var title = data.lead.normalizedtitle;
		// var titleLen = title.split(" ").length;
		console.log(data.lead.normalizedtitle.split(" ").length>2);
		if (data.lead.sections.length<8) return false;
		else if (data.lead.normalizedtitle.text.includes("(")) return false;
		else if (data.lead.normalizedtitle.split(" ").length>2) return false;
		else if (!data.lead.sections[0].text.includes("infobox")) return false;
		else if (data.lead.sections[0].text.includes("ambox")) return false;
		else return true;
		}

	async function translate(text, lang){
		// lang : string (ex: 'en-ru')
		const key = 'trnsl.1.1.20190728T002925Z.a6ed32bedce2d146.600adea4f41cf3dca7016feced65fe2d48e1bda6';
		let endpoint = "https://translate.yandex.net/api/v1.5/tr.json/translate";
		endpoint += "?key=";
		endpoint += key;
		endpoint += "&text=";
		endpoint += text;
		endpoint += "&lang=";
		endpoint += lang;

		let response = await(fetch(endpoint));
		let data = await response.json();
		return data;
	}

	function paraphrase(text){
		translate(text, "en-ru").then(data =>
			translate(data.text[0], "ru-en").then(ans =>
				translated_text = ans.text[0]));
	}

	function draw() {
		ctx.clearRect(0, 0, canvas.width, canvas.height);
		ctx.beginPath();
		//ctx.arc(x, y, 10, 0, Math.PI*2);
		//ctx.arc(x2, y2, 10, 0, Math.PI*2);
		ctx.fillStyle = "#0095DD";
		ctx.fillText(str.lead.normalizedtitle, 10, 25);

		// hint/paraphrasing section
		var div = document.createElement("div");
		div.innerHTML = html;
		var text = div.textContent || div.innerText || "";
		var res = text.split(".");
		if(change) {
			n = Math.floor(Math.random() * res.length);
			paraphrase(res[n]);
			change = !change; 
		} 
		ctx.fillText(translated_text, 10, 50);

		let obj = str.lead.image.urls;
		res = Object.keys(obj).map(key => obj[key]);
		myImg.src = res[0];

		ctx.drawImage(myImg,100,100);
		ctx.fill();
		ctx.closePath();

		x = (canvas.height/1.5) + 100 * Math.sin(3 * t + Math.PI / 4);
		y = (canvas.width/3) + 75 * Math.sin(5 * t);
		x2 = (canvas.height/1.5) + 100 * Math.sin(3 * (t - 0.1) + Math.PI / 4);
		y2 = (canvas.width/3) + 75 * Math.sin(5 * (t - 0.1));

    	t += 0.01;
	}
	getRandomArticle();
	setInterval(draw, 10);
</script>

</body>
</html>